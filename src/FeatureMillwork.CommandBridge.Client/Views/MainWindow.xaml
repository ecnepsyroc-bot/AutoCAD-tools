<Window x:Class="FeatureMillwork.CommandBridge.Client.Views.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="clr-namespace:FeatureMillwork.CommandBridge.Client.ViewModels"
        Title="AutoCAD Command Bridge"
        Height="700" Width="1000"
        MinHeight="500" MinWidth="800"
        Background="{StaticResource BackgroundBrush}"
        WindowStartupLocation="CenterScreen">

    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <Grid Grid.Row="0" Margin="0,0,0,16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <StackPanel Orientation="Horizontal" VerticalAlignment="Center">
                <TextBlock Text="AutoCAD Command Bridge"
                           FontSize="24" FontWeight="SemiBold"
                           Foreground="{StaticResource TextPrimaryBrush}"/>
                <Border CornerRadius="4" Padding="8,4" Margin="16,0,0,0"
                        VerticalAlignment="Center">
                    <Border.Style>
                        <Style TargetType="Border">
                            <Setter Property="Background" Value="#3B82F6"/>
                            <Style.Triggers>
                                <DataTrigger Binding="{Binding IsConnected}" Value="True">
                                    <Setter Property="Background" Value="{StaticResource SuccessBrush}"/>
                                </DataTrigger>
                            </Style.Triggers>
                        </Style>
                    </Border.Style>
                    <TextBlock Text="{Binding ConnectionStatus}"
                               Foreground="White" FontSize="12"/>
                </Border>
                <TextBlock Text="{Binding AutoCADVersion, StringFormat='AutoCAD {0}'}"
                           Foreground="{StaticResource TextSecondaryBrush}"
                           VerticalAlignment="Center" Margin="12,0,0,0"
                           Visibility="{Binding AutoCADVersion, Converter={StaticResource StringToVisibilityConverter}}"/>
            </StackPanel>

            <StackPanel Grid.Column="1" Orientation="Horizontal">
                <Button Content="Connect" Command="{Binding ConnectCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding IsConnected, Converter={StaticResource InverseBoolConverter}}"
                        Margin="0,0,8,0"/>
                <Button Content="Disconnect" Command="{Binding DisconnectCommand}"
                        Style="{StaticResource SecondaryButton}"
                        IsEnabled="{Binding IsConnected}"/>
            </StackPanel>
        </Grid>

        <!-- Statistics Cards -->
        <ItemsControl Grid.Row="1" Margin="0,0,0,16">
            <ItemsControl.ItemsPanel>
                <ItemsPanelTemplate>
                    <UniformGrid Rows="1" Columns="6"/>
                </ItemsPanelTemplate>
            </ItemsControl.ItemsPanel>

            <Border Style="{StaticResource StatCard}" Margin="0,0,8,0">
                <StackPanel>
                    <TextBlock Text="Commands" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Text="{Binding CommandCount}" Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="24" FontWeight="Bold"/>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource StatCard}" Margin="4,0">
                <StackPanel>
                    <TextBlock Text="Errors" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Text="{Binding ErrorCount}" Foreground="{StaticResource ErrorBrush}"
                               FontSize="24" FontWeight="Bold"/>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource StatCard}" Margin="4,0">
                <StackPanel>
                    <TextBlock Text="Error Rate" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Foreground="{StaticResource TextPrimaryBrush}" FontSize="24" FontWeight="Bold">
                        <Run Text="{Binding ErrorRate, StringFormat='{}{0:F1}'}"/><Run Text="%"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource StatCard}" Margin="4,0">
                <StackPanel>
                    <TextBlock Text="Avg Time" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Foreground="{StaticResource TextPrimaryBrush}" FontSize="24" FontWeight="Bold">
                        <Run Text="{Binding AverageExecutionTime, StringFormat='{}{0:F0}'}"/><Run Text=" ms"/>
                    </TextBlock>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource StatCard}" Margin="4,0">
                <StackPanel>
                    <TextBlock Text="Cmd/Min" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Text="{Binding CommandsPerMinute, StringFormat='{}{0:F1}'}"
                               Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="24" FontWeight="Bold"/>
                </StackPanel>
            </Border>

            <Border Style="{StaticResource StatCard}" Margin="8,0,0,0">
                <StackPanel>
                    <TextBlock Text="Session" Foreground="{StaticResource TextSecondaryBrush}" FontSize="12"/>
                    <TextBlock Text="{Binding SessionDuration}" Foreground="{StaticResource TextPrimaryBrush}"
                               FontSize="24" FontWeight="Bold" FontFamily="Consolas"/>
                </StackPanel>
            </Border>
        </ItemsControl>

        <!-- Main Content -->
        <Grid Grid.Row="2">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="300"/>
            </Grid.ColumnDefinitions>

            <!-- Log Panel -->
            <Border Style="{StaticResource Card}" Margin="0,0,8,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <Grid Margin="0,0,0,12">
                        <TextBlock Text="Activity Log" FontWeight="SemiBold" FontSize="14"
                                   Foreground="{StaticResource TextPrimaryBrush}"/>
                        <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                            <Button Content="Clear" Command="{Binding ClearLogCommand}"
                                    Style="{StaticResource SecondaryButton}" Padding="12,4"/>
                            <Button Content="Export" Command="{Binding ExportSessionCommand}"
                                    Style="{StaticResource SecondaryButton}" Padding="12,4" Margin="8,0,0,0"/>
                        </StackPanel>
                    </Grid>

                    <ListBox Grid.Row="1" ItemsSource="{Binding LogEntries}"
                             Style="{StaticResource LogListBox}"
                             ScrollViewer.CanContentScroll="True"
                             VirtualizingPanel.ScrollUnit="Pixel"
                             x:Name="LogList">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <Grid Margin="0,2">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80"/>
                                        <ColumnDefinition Width="*"/>
                                    </Grid.ColumnDefinitions>
                                    <TextBlock Text="{Binding TimestampFormatted}"
                                               Foreground="{StaticResource TextSecondaryBrush}"
                                               FontFamily="Consolas" FontSize="11"/>
                                    <TextBlock Grid.Column="1" Text="{Binding Message}"
                                               TextWrapping="Wrap" FontFamily="Consolas" FontSize="12">
                                        <TextBlock.Style>
                                            <Style TargetType="TextBlock">
                                                <Setter Property="Foreground" Value="{StaticResource TextPrimaryBrush}"/>
                                                <Style.Triggers>
                                                    <DataTrigger Binding="{Binding Level}" Value="Error">
                                                        <Setter Property="Foreground" Value="{StaticResource ErrorBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Level}" Value="Warning">
                                                        <Setter Property="Foreground" Value="{StaticResource WarningBrush}"/>
                                                    </DataTrigger>
                                                    <DataTrigger Binding="{Binding Level}" Value="Success">
                                                        <Setter Property="Foreground" Value="{StaticResource SuccessBrush}"/>
                                                    </DataTrigger>
                                                </Style.Triggers>
                                            </Style>
                                        </TextBlock.Style>
                                    </TextBlock>
                                </Grid>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </Grid>
            </Border>

            <!-- Side Panel -->
            <Grid Grid.Column="1">
                <Grid.RowDefinitions>
                    <RowDefinition Height="*"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Recent Commands -->
                <Border Style="{StaticResource Card}" Margin="8,0,0,8">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Recent Commands" FontWeight="SemiBold" FontSize="14"
                                   Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,12"/>

                        <ListBox Grid.Row="1" ItemsSource="{Binding RecentCommands}"
                                 Background="Transparent" BorderThickness="0"
                                 ScrollViewer.HorizontalScrollBarVisibility="Disabled">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding Command}"
                                                   Foreground="{StaticResource TextPrimaryBrush}"
                                                   FontFamily="Consolas" FontSize="12"
                                                   TextTrimming="CharacterEllipsis"/>
                                        <TextBlock Grid.Column="1"
                                                   Text="{Binding DurationMs, StringFormat='{}{0:F0} ms'}"
                                                   Foreground="{StaticResource TextSecondaryBrush}"
                                                   FontFamily="Consolas" FontSize="11"
                                                   Margin="8,0,0,0"/>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>

                <!-- Top Errors -->
                <Border Grid.Row="1" Style="{StaticResource Card}" Margin="8,8,0,0">
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="*"/>
                        </Grid.RowDefinitions>

                        <TextBlock Text="Top Errors" FontWeight="SemiBold" FontSize="14"
                                   Foreground="{StaticResource TextPrimaryBrush}" Margin="0,0,0,12"/>

                        <ListBox Grid.Row="1" ItemsSource="{Binding TopErrors}"
                                 Background="Transparent" BorderThickness="0">
                            <ListBox.ItemTemplate>
                                <DataTemplate>
                                    <Grid Margin="0,2">
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="*"/>
                                            <ColumnDefinition Width="Auto"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Text="{Binding Pattern}"
                                                   Foreground="{StaticResource ErrorBrush}"
                                                   FontSize="12"/>
                                        <Border Grid.Column="1" Background="{StaticResource ErrorBrush}"
                                                CornerRadius="10" Padding="8,2" Margin="8,0,0,0">
                                            <TextBlock Text="{Binding Count}" Foreground="White"
                                                       FontSize="11" FontWeight="Bold"/>
                                        </Border>
                                    </Grid>
                                </DataTemplate>
                            </ListBox.ItemTemplate>
                        </ListBox>
                    </Grid>
                </Border>
            </Grid>
        </Grid>

        <!-- Command Input -->
        <Border Grid.Row="3" Style="{StaticResource Card}" Margin="0,16,0,0" Padding="12">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBox Text="{Binding CommandInput, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         IsEnabled="{Binding IsConnected}">
                    <TextBox.InputBindings>
                        <KeyBinding Key="Return" Command="{Binding SendCommandCommand}"/>
                    </TextBox.InputBindings>
                </TextBox>
                <Button Grid.Column="1" Content="Send Command"
                        Command="{Binding SendCommandCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding IsConnected}"
                        Margin="8,0,16,0"/>

                <TextBox Grid.Column="2" Text="{Binding LispInput, UpdateSourceTrigger=PropertyChanged}"
                         Style="{StaticResource ModernTextBox}"
                         AcceptsReturn="True" TextWrapping="Wrap"
                         MaxHeight="60"
                         IsEnabled="{Binding IsConnected}"/>
                <Button Grid.Column="3" Content="Execute LISP"
                        Command="{Binding SendLispCommand}"
                        Style="{StaticResource PrimaryButton}"
                        IsEnabled="{Binding IsConnected}"
                        Margin="8,0,0,0"/>
            </Grid>
        </Border>
    </Grid>
</Window>
